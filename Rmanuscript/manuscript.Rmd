---
title: 'How many, when and which birds to equip?'
description: | 
  Using ringing data to inform the deployment of geolocators
author:
- name: Raphaël Nussbaumer
  affil: a,b
  email: raphael.nussbaumer@arocha.org
  affiliation: 
    - A Rocha Kenya, Watamu, Kenya
    - Swiss Ornithological Institue, Sempach, Switzerland
  orcid_id: 0000-0002-8185-1020
- name: Kirao Lennox
  affiliation: A Rocha Kenya, Watamu, Kenya
  affil: a
  email: lennox.kirao@arocha.org
  orcid_id: 0000-0002-3548-5787
- name: Felix Liechti
  affil: b
  affiliation: Swiss Ornithological Institue, Sempach, Switzerland
  email: felix.liechti@vogelwarte.ch
  orcid_id: 0000-0001-9473-0837
- name: Colin Jackson
  affil: a
  affiliation: A Rocha Kenya, Watamu, Kenya
  email: colin.jackson@arocha.org
  orcid_id: 0000-0003-2280-1397
type: Journal Ringing & Migration
output:
  #rticles::tf_article: default
  #html_document: default
  #rmdformats::html_clean:
  #  use_bookdown: true
  #  code_folding: hide
  #  thumbnails: false
  distill::distill_article:
    toc: true
  #rmarkdown::github_document: default
bibliography: MyCollection.bib
link-citations: yes
date: December, 2020
abstract: "Light-level geolocators are increasingly used to study the migration of
  small birds. Thanks to their relatively low cost, they are particularly well-positioned
  to be deployed broadly across less well-financed and understudied regions of the
  world, such as the Africa. A main drawback of geolocators is the need to recapture
  equipped birds to retrieve the data. Therefore, maximizing the recapture rate is
  critical to the success of any geolocator study. Using the example of a geolocator
  study on the coast of Kenya on Red-capped Robin-chats, this paper demonstrates how
  the use of an ringing data can help optimize the deployment of geolocators, both
  in terms of how many birds to set out to equip, and when/which birds to equip to
  maximize recapture in the subsequent years. We found that ringing data can help
  accurately estimate how many geolocators to order and provides insights into which
  classes of birds (based on age, capture history, and timing within the season) are
  most likely to be recaptured."
keywords: "geolocators; ringing; red-capped robin-chat; migration; intra-african;
  bird; afro-tropical; \n"
header-includes: |
  \usepackage{hyperref}
  \usepackage[utf8]{inputenc}
  \def\tightlist{}
  \usepackage{gensymb}
affiliation:
- num: a
  address: |
    A Rocha Kenya, Watamu, Kenya
- num: b
  address: |
    Swiss Ornithological Institute, Sempach, Switzerland
---

<aside>
<div class="layout-chunk" data-layout="l-body">
<input onclick="codefolder(&#39;.sourceCode&#39;);" type="button" value="Hide Code" id="codefolder-button" style=""/>
<script>
  function codefolder(query) {

    var x = document.querySelectorAll(query);
    if (x.length === 0) return;

    function toggle_vis(o) {
      var d = o.style.display;
      o.style.display = (d === 'block' || d === '') ? 'none':'block';
    }

    for (i = 0; i < x.length; i++) {
      var y = x[i];
      toggle_vis(y);
    }

    var elem = document.getElementById("codefolder-button");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
  }
</script>
<script>
  window.addEventListener('load', function () {
    codefolder('.sourceCode');
  });
</script>
</div>
</aside>

# Abstract

Light-level geolocators are increasingly used to study the migration of small birds. Thanks to their relatively low cost, they are particularly well-positioned to be deployed broadly across less well-financed and understudied regions of the world, such as the Africa. A main drawback of geolocators is the need to recapture equipped birds to retrieve the data. Therefore, maximizing the recapture rate is critical to the success of any geolocator study. Using the example of a geolocator study on the coast of Kenya on Red-capped Robin-chats, this paper demonstrates how the use of an ringing data can help optimize the deployment of geolocators, both in terms of how many birds to set out to equip, and when/which birds to equip to maximize recapture in the subsequent years. We found that ringing data can help accurately estimate how many geolocators to order and provides insights into which classes of birds (based on age, capture history, and timing within the season) are most likely to be recaptured.

# Introduction

Light-level geolocators are a well-established technology used to study bird migration. They have become popular due to their relatively low cost and light weight, making them the only tool available to study migration patterns of smaller birds [@Bridge2011]. For these reasons, geolocators have helped advance our understanding of bird migration on a number of levels: identifying migration routes and wintering locations [e.g. @Salewski2013; @Smith2014; @Liechti2015; @Kralj2020], revealing migration strategies [e.g. @Adamik2016; @Briedis2019; @Hahn2020] and migratory connectivity [e.g. @Finch2015; @Prochazka2017; @McKinnon2018a], among others. 
Geolocators bear strong potential to uncover long-distance Afro-tropical migration patterns, many of which remain still largely unknown [e.g. @Benson1982; @Bennun2000; @Cox2011; @Bussiere2015; @Nwaogu2016; @Osinubi2018]. As habitat destruction and climate change accelerate and adversely affect migrant birds, it is becoming urgent to better understand these patterns to effectively protect these migratory bird populations [e.g. @Simmons2004; @Sekercioglu2010; @Sekercioglu2012; @Vickery2014]. Geolocators are instrumental in helping us gain understanding of migration routes, timing, triggers and variability, as well as identifying breeding, wintering and stopover sites to protect. Thanks to their low price, geolocators are particularly well-suited to projects with limited budgets. 
However, geolocators are not without drawbacks. The tags must be retrieved to recover data, harnesses can fail, bird survival might be impacted, latitudinal precision can be relatively poor, and the data analysis can be difficult and prone to errors. With the increasing number of studies using geolocators, these challenges have been partially addressed. Increased experience with this technology has helped improve survival rates through minimum relative load and non-elastic harness technology [e.g. @Streby2015; @Weiser2015; @Brlik2020]. Data analysis has also become more accessible and accurate (e.g. @Lisovski2012; @Lisovski2020) and common pitfalls in analysis have been discussed [e.g. @Fudickar2012; @Lisovski2012; @Lisovski2018]. Finally, more recent geolocators also measure temperature, air pressure and bird activity, providing further precision in geolocation and additional research opportunities [e.g. @Meier2018; @Liechti2018; @Dhanjal-Adams2018; @Sjoberg2018; @Jiguet2019; @Briedis2020].
Despite this progress, geolocator studies still need to be carefully planned (in terms of field time, research questions, sample size etc.) to improve the recapture rate of birds in subsequent years. In this study, we present an example of one geolocator study carried out on two Afro-tropical migrants in Kenya. This study will demonstrate how pre-deployment analysis using an existing ringing database can help optimize the deployment of geolocators. We focus on two questions in particular: (1) how many birds can we expect to capture during a full season for a given ringing schedule and (2) how can we maximize bird recapture by equipping specific classes of birds (e.g. sex, age) during specific periods of the year?


# Materials and methods

```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(RODBC)
library(mgcv)
library(mgcViz)
library(visreg)
library(mice)
library(lubridate)
library(RColorBrewer)
library(pammtools)
theme_set(theme_bw())
library(wesanderson)
pal.name <- "Zissou1"
```

## Ringing site and database
```{r, echo=TRUE}
specie_name = 'Red-capped Robin Chat'
dm <- read.csv('../data/ringing_data.csv') %>% 
  filter(Location=='Mwamba Plot 28, Watamu' | Location=='Mwamba plot 28') %>% 
  filter(! NettingSite %in% c('Beach','boat shed','DINING ROOM','Compost','by compost','Kilifi Bofa','Mwamba Dining Room','by volunteer rooms','Spring trap by lamp post','Office','Net by bird bath.','compost site','Bird Bath')) %>% 
  filter(! SessionNotes %in% c('Net at birdbath; BC = Bernard Chege','1 net behind birdbath')) %>% 
  mutate(DayOfYear = Julian)
  #filter(Date>'2003-01-01'&Date<'2019-01-01')
```

The A Rocha Kenya Conservation Centre is located on the coast of Kenya and in the middle of the Northern Zanzibar-Inhambane Coastal Forest Mosaic ecoregion ([3°22'36.3"S 39°59'16.9"E](https://goo.gl/maps/4Lrz8iBHdvjnZCNg9)). This region is recognized for its high biodiversity value [@Marris2010] yet faces increasing habitat fragmentation due to the expansion of agriculture and charcoal burning [@Burgess2000CoastalFO]. 

The Conservation Centre is located on a residential coastal scrub/forest that has benefited from limited habitat change over the last 50 years [@Alemayehu2016], in the effort to preserve the ecosystems for tourism purposes. Mist nets are placed in a nature trail that runs through a small patch of forest managed by the Conservation centre. 

```{r, echo=TRUE}
dt <- dm %>%    
  group_by(SessionID) %>% 
  summarise(Month=first(Month), Year = first(Year), .groups="drop") %>% 
  group_by(Month, Year) %>%
  summarise(nb = n(), .groups="drop")


dmf <- dm %>%
  arrange(Date) %>% 
  group_by(Year) %>% 
  mutate(n = ifelse(is.na(CommonName) | CommonName!=specie_name ,0,1), 
         CountOfYear = cumsum(n),
         ) %>% 
  ungroup %>% 
  group_by(RingNo) %>% 
  mutate(isFirstOfYear = !(Year==lag(Year, default=FALSE))) %>% 
  ungroup() 

dmrcrc <- dmf %>% 
  mutate(
    NetsOther = str_replace(NetsOther, '11 total', '11'),
    NetsOther = str_replace(NetsOther, '10mx3','30'),
    NetsOther = str_replace(NetsOther, '10m x3','11'),
    NetsOther = str_replace(NetsOther, '2 10m','20'),
    NetsOther = str_replace(NetsOther, '1x10m','10'),
    NetsOther = str_replace(NetsOther, '10m x1','10'),
    NetsOther = str_replace(NetsOther, '10m x 1','10'),
    NetsOther = str_replace(NetsOther, '10mx2','20'),
    NetsOther = str_replace(NetsOther, '10mx1','10'),
    NetsOther = str_replace(NetsOther, '10m x 1','10'),
    NetsOther = str_replace(NetsOther, '10x1','10'),
    NetsOther = str_replace(NetsOther, '14x1, 10','24'),
    NetsOther = str_replace(NetsOther, '14x1,10','24'),
    NetsOther = str_replace(NetsOther, '10x3','30'),
    NetsOther = replace_na(NetsOther, '0'),
    NetsOther = as.numeric(NetsOther),
    NetsLength = Nets6m*6 + Nets9m*9 + Nets12m*12 + Nets18m*18 + NetsOther,
    NetsLength = ifelse(NetsLength==0,NA,NetsLength),
    NetsDuration = as.POSIXct(NetsClosed)-as.POSIXct(NetsOpen),
    NetsOpen =  hour(as.POSIXct(NetsOpen)) + minute(as.POSIXct(NetsOpen))/60,
    WeatherCat = ifelse(!is.na(Weather), 'none', NA),
    WeatherCat = ifelse(grepl('rain',Weather), 'little', WeatherCat),
    WeatherCat = ifelse(grepl('drizzle',  Weather), 'little', WeatherCat),
    WeatherCat = ifelse(grepl('shower' , Weather), 'little', WeatherCat),
    WeatherCat = ifelse(grepl('heavy' , Weather), 'strong', WeatherCat),
  ) %>% 
  mutate(
    NetsLength = ifelse(SessionID==971,NA,NetsLength), # remove aberant data
    NetsOpen = ifelse(SessionID==517,6,NetsOpen), # correct 18:00->6
    NetsDuration = ifelse(SessionID==637,NA,NetsDuration), # correct 18:00->6
    NetsOpen = ifelse(NetsOpen>7|NetsOpen<5.5, NA, NetsOpen),
 #   NetsDuration = ifelse(!(abs(NetsDuration - median(NetsDuration, na.rm = T)) < 3*sd(NetsDuration, na.rm = T)),NA,NetsDuration),
    ) %>% 
 #  filter( !SessionID %in% c()) %>%  !NetsOpen>8 & NetsDuration>7 
  group_by(SessionID) %>% 
  summarize( 
    Date = as.Date(first(Date)), 
    DayOfYear = median(DayOfYear), 
    Year = median(Year), 
    fYear = factor(Year),
    # CountFoY = sum(CommonName==specie_name & isFirstOfYear, na.rm = TRUE), 
    Count = sum(CommonName==specie_name, na.rm = TRUE), 
    CountAd = sum(CommonName==specie_name & Age != 0 & Age==4 & isFirstOfYear, na.rm = TRUE),
    CountJuv = sum(CommonName==specie_name & Age != 0 & Age!=4 & isFirstOfYear, na.rm = TRUE),
    NetsLength = median(NetsLength),
    NetsOpen = median(NetsOpen),
    NetsDuration = as.numeric(median(NetsDuration)),
    WeatherCat = as.factor(first(WeatherCat)),
    #countFirstOfYear = mean(countFirstOfYear),
    .groups="drop_last") #%>% 
  # mutate(DayOfYear = ifelse(DayOfYear<100,DayOfYear+365,DayOfYear)) 
  # %>% filter( !(SessionID==512) )

tf = function(t){
  paste0(
    'M=', format(as.POSIXct(Sys.Date() + mean(t,na.rm=T)/24), "%H:%M", tz="UTC"), ' ; SD=',
    format(as.POSIXct(Sys.Date() + sd(t,na.rm=T)/24), "%H:%M", tz="UTC")
  )
}
```


In this study, we use the ringing dataset from ringing sessions conducted regularly from 2002 to present (see Figure \@ref(fig:coverage) in [SM1. Data extends]). Up to early 2019, the dataset consists of `r nrow(dm)` entries of `r length(unique(dm$RingNo))` rings covering `r length(unique(dm$SpeciesID))` species collected during `r nrow(dmrcrc)` sessions. The ringing effort presents some temporal variability, as well as variability in the metadata recorded (see [SM1. Data extends]). In general, sessions start at sunrise (`r tf(dmrcrc$NetsOpen)`) and last until bird activity slows down (session duration `r tf(dmrcrc$NetsDuration)`) (see Figure \@ref(fig:metadata) in [SM1 Data extends]). On average, a total of `r mean(dmrcrc$NetsLength,na.rm=TRUE)` m (SD=`r sd(dmrcrc$NetsLength,na.rm=TRUE)` m) of nets were used. Descriptive notes on weather conditions were also included, and later classified according to their expected influence on the capture rate (none, little, large). We manually checked extreme values in the dataset and removed those that could not be verified.

In addition, we also present the ringing data of 2020, when the geolocators were first deployed. We did not include this data in the fitting of the models but rather used it for comparison and discussion purposes.

In this case study, geolocators were placed on Red-capped Robin-chats Cossypha natalensis (RCRC), a terrestrial thrush wintering in the area from April to October, to uncover their summering site and migration routes [@Nussbaumer2020]. RCRC are known to hold territory on their wintering sites and show site fidelity (C. Jackson, personal communication), thus making them an ideal candidate for a geolocator study.


```{r, echo=TRUE}
dm2020 <- read.csv('../data/ringing_mwamba_rcrc_2020.csv') %>% 
 filter(Location=='Mwamba') %>% 
  mutate(
    date=dmy(ï..date),
    CloseTime = hour(hm(CloseTime)) + minute(hm(CloseTime))/60,
    OpenTime = hour(hm(OpenTime)) + minute(hm(OpenTime))/60,
    n = !is.na(Age),
    CountOfYear = cumsum(n),
    isRetrap = NewRetrap=="R",
    ) %>% 
  group_by(date)

dm2020s <- dm2020 %>% 
  summarise(
    Date = date,
    DayOfYear = as.numeric(format(date, "%j")),
    Count = sum( !is.na(Age), na.rm = T ),
    CountFOY = sum( !is.na(Age) & !isRetrap , na.rm = T ),
    CountJuv = sum(Age==3, na.rm = T),
    CountAd = sum(Age==4, na.rm = T),
    OpenTime = median(OpenTime),
    CloseTime = median(CloseTime),
    Duration = CloseTime-OpenTime,
    .groups = "drop") %>% 
  unique() %>% 
  mutate(
    CountFOY.cum = cumsum(CountFOY),
  )
  
``` 




## Capture model

An early question in the planning stage is how many geolocators to deploy and therefore order. To answer this, it is important to accurately estimate the number of individuals that can realistically be captured per ringing season. Geolocators are configured to collect data for a single year, and therefore cannot be kept for future studies. Overestimating the individuals captured would thus result in wasting devices, while underestimating would result in missed opportunities. The estimation also directly influences the ringing effort planned (i.e. number of sessions, duration of session, number of nets etc). To address this question, we followed a three-step process described below.

In the first step, we modelled the number of RCRC captured per session using a generalized additive model (GAM), assuming the number of captures follows a Poisson distribution. The predictor variables tested in the model are (1) year (2) day-of-year, (3) duration of the session, (4) total length of nets, (5) starting time and (6) weather conditions. To overcome the lack of sufficient data for the duration, start time and length of nets, we used multiple imputation methods by chained equations [@Azur2011] to generate 30 sets of data without any missing values. For each of these sets, a GAM model was fitted.

```{r, echo=TRUE, warning=F}
dmrcrc.imputed <- dmrcrc %>% 
  bind_rows(dmrcrc %>% mutate(DayOfYear = DayOfYear+360)) %>% 
  mice(print=F, m = 30, seed=123456789) %>% 
  complete("all")

mod=list(); modY=list(); modAd=list(); modJuv=list(); i<-0
for(d in dmrcrc.imputed){
  i<-i+1
  mod[[i]] <- gam( Count ~ s(DayOfYear) + NetsDuration + s(NetsLength), family=poisson(), data=d)
  modY[[i]] <- gam( Count ~ s(Year) + s(DayOfYear) + NetsDuration + NetsLength, family=poisson(), data=d)
  modAd[[i]] <- gam( CountAd ~ s(DayOfYear) + NetsDuration + s(NetsLength), family=poisson(), data=d)
  modJuv[[i]] <- gam( CountJuv ~ s(DayOfYear) + NetsDuration + s(NetsLength), family=poisson(), data=d)
}
```

In the second step, we addressed the problem that RCRC can only be equipped once a year. A first approach tested was to model the count of new birds (i.e., birds that have not yet been captured in the same year) rather than the total number of birds. However, this count depends on how many RCRC have already been equipped earlier in the year. Instead, we preferred to model the probability that a bird captured was not already captured in the same year. This probability is modelled with a Generalized Linear Model (GLM) using a binomial family and a single explanatory variable consisting of the total number of RCRC captured in the year. 

```{r, echo=TRUE}
# modFoY=glm(dmf, formula = as.integer(isFirstOfYear) ~ DayOfYear + CountOfYear, family = "binomial" )
modFoY = glm(dmf, formula = isFirstOfYear ~ CountOfYear, family = "binomial" )

predictmodFOY <- data.frame(CountOfYear = seq(1,max(dmf$CountOfYear,na.rm = T))) %>%
  mutate(
    fit.link = predict(modFoY, ., type = "link"),
    se.fit.link = predict(modFoY, ., type = "link", se.fit = T) %>% .$se.fit,
    fit = modFoY$family$linkinv(fit.link),
    se.fit = predict(modFoY, ., type = "response", se.fit = T) %>% .$se.fit,
    lwr3 = modFoY$family$linkinv(fit.link + 3*se.fit.link),
    upr3 = modFoY$family$linkinv(fit.link - 3*se.fit.link),
    ) 
```

In the third step, we used the two models above to predict the number of RCRC that can be captured over one year. This number is estimated from the prediction of the models under various ringing scenarios. The default scenario for our ringing season of 2020 is to ring every week for 4 hours using 156 m of nets. Using the first model and this information, we can estimate the total number of RCRC that would be captured in the season. Knowing how many birds have been captured, we used the second model to predict how many unique RCRC can be equipped along the year by multiplying the number of captures by the probability of each individual being a new bird. Finally, assuming that the sessions are independent conditional to the model, we estimate the total number with a cumulative sum over the year. 

This approach was performed under different scenarios where we modified the number of ringing sessions, total length of nets, and duration of ringing session. The default scenario includes 4 hr-ringing sessions every 10 days with 156 m of nets. We tested the influence of increasing the duration of the ringing sessions to 6 hrs and the length of nets to 225 m. In addition, we tested an optimized ringing schedule where more ringing sessions are held during the peak passage. Finally, we also compared the actual number of RCRC captured in 2020 with the prediction of our model using the exact session durations and lengths of nets. 

```{r, echo=TRUE}
predictf = function(modf, yearf, dayf, netsLengthf, netsDurationf) {
  tmp <- data.frame(Year=rep(yearf, times = length(dayf)), DayOfYear=rep(dayf, each = length(yearf)), NetsLength=netsLengthf, NetsDuration=netsDurationf)
  
  modf %>% 
    lapply(predict.gam,  newdata=tmp, se.fit = TRUE, type = "link") %>% 
    #lapply(as_tibble) %>% 
    #lapply(rename_with, ~ paste0(.x,"e"))
    bind_cols(.name_repair = ~ vctrs::vec_as_names(..., repair = "unique", quiet = TRUE) ) %>% 
    summarise(
      fit.link = rowMeans(select(., starts_with("fit"))),
      se.fit.link = rowMeans(select(., starts_with("se.fit")))
    ) %>% 
    mutate(
      fit =  modf[[1]]$family$linkinv(fit.link),
      lwr =  modf[[1]]$family$linkinv(fit.link-se.fit.link),
      upr =  modf[[1]]$family$linkinv(fit.link+se.fit.link),
    ) %>% 
    select(-one_of(c('fit.link','se.fit.link'))) %>% 
    bind_cols(tmp) %>% 
    mutate(date=as.Date(DayOfYear, origin = paste0(Year, "-01-01")))
}

yearf = seq(1998,2020,1)
dayf = as.numeric(0:450)
netsLengthf = 156
netsDurationf = 4


predictmod <- predictf(mod, yearf, dayf, netsLengthf, netsDurationf) %>% 
  left_join(predictf(modY, yearf, dayf, netsLengthf, netsDurationf) %>% 
              mutate(fitY=fit, lwrY=lwr,uprY=upr) %>% 
              select(-one_of(c('fit','lwr','upr'))), by = c("Year", "DayOfYear", "NetsLength", "NetsDuration", "date")) %>% 
  left_join(predictf(modAd, yearf, dayf, netsLengthf, netsDurationf) %>% 
              mutate(fitAd=fit, lwrAd=lwr,uprAd=upr) %>% 
              select(-one_of(c('fit','lwr','upr'))), by = c("Year", "DayOfYear", "NetsLength", "NetsDuration", "date")) %>% 
  left_join(predictf(modJuv, yearf, dayf, netsLengthf, netsDurationf) %>% 
              mutate(fitJuv=fit,lwrJuv=lwr,uprJuv=upr) %>% 
              select(-one_of(c('fit','lwr','upr'))), by = c("Year", "DayOfYear", "NetsLength", "NetsDuration", "date"))
```


## Recapture model

Data collected by geolocators can only be retrieved if the equipped bird is recaptured in the following years. Consequently, to optimize the study it is essential to equip those birds that are most likely to be recaptured. Here too, the ringing database can inform this decision, in this case by providing the recapture rate of a bird as a function of the date of equipping but also of the age and weight of the bird. Using this information, the ringer can make an informed decision about whether or not to equip a captured bird. This decision should also account for the total number of geolocators available and the number of sessions left. 

In this study we looked at two parameters: the time of year and the age class (adult or juvenile). The recapture probability is estimated by modelling the binomial response of whether a captured bird will be recaptured in the following years: we consider that an individual is recaptured if the bird has been recaptured at least once in any of the following years, and this is independent from whether it was already captured in the past. We modelled the count of adults and juveniles per session separately to reveal the influence of age on recapture rates. The weight of the bird was left out of the model as it showed little to no effect on the recapture rate (see Figure \@ref(fig:weight-recapture) in [SM3. Recapture model]). Additionally, we also compare the recapture rate for RCRC captured for the first time and those which have already been equipped. 


```{r, echo=TRUE, warning=FALSE}
dr <- dm %>% 
  filter(CommonName==specie_name) %>% 
  arrange(Date) %>% 
  group_by(RingNo) %>% 
  mutate(n = 1, 
         retrap_i = cumsum(n)-1, 
         isRetrap = if_else(is.na(lead(retrap_i)>retrap_i),0, 1),
         duration_next_capture = as.numeric(difftime(lead(Date),Date,units='days')),
         duration_last_capture = as.numeric(difftime(last(Date),Date,units='days')),
         nextSeason = last(Year)>Year,
         Yearsince = Year-first(Year),
         isAdult = ifelse(Age==4, TRUE, FALSE),
         isARetrap = first(Year)<Year
         ) %>% 
  select(RingNo, Date, Year, DayOfYear, retrap_i, isRetrap, isARetrap, nextSeason, duration_next_capture, duration_last_capture, isAdult, Yearsince, Weight) %>% 
  arrange(RingNo) 

modr <- gam(dr, formula = nextSeason ~ s(DayOfYear) , family="binomial")
modrA <- gam(dr %>% filter(isAdult), formula = nextSeason ~ s(DayOfYear), family="binomial")
modrJ <- gam(dr %>% filter(!isAdult), formula = nextSeason ~ s(DayOfYear), family="binomial")
modrO <- gam(dr %>% filter(retrap_i>0), formula = nextSeason ~ s(DayOfYear), family="binomial")
modrN <- gam(dr %>% filter(retrap_i==1), formula = nextSeason ~ s(DayOfYear), family="binomial")

predictmodr <- data.frame(DayOfYear = seq(min(dr$DayOfYear),max(dr$DayOfYear))) %>%
  mutate(
    r.fit = predict(modr, ., type = "response"),
    r.se.fit = predict(modr, ., type = "response", se.fit = T) %>% .$se.fit,
    rA.fit = predict(modrA, ., type = "response"),
    rA.se.fit = predict(modrA, ., type = "response", se.fit = T) %>% .$se.fit,
    rJ.fit = predict(modrJ, ., type = "response"),
    rJ.se.fit = predict(modrJ, ., type = "response", se.fit = T) %>% .$se.fit,
    ) 
```

All computation was performed on R [@team2013r], using the MCGV package [@wood2017generalized] for GAM, and the Mice Package [@Buuren2011] for the imputation. 








# Results


## Capture model

A GAM model was fitted to the data to model the number of RCRC captured for each session. After testing several parametrizations of the model (see [SM2.  Capture Model]), we retained the capture model that included a smooth function of day-of year, year and total length of a linear function of the duration of the session. The fitted model for the default case (156 m of nets and session duration of 4 hrs) together with the raw counts data is illustrated in Figure \@ref(fig:seasonal-variation-counts). The model fits a typical migrant phenology curve, with a steep increase in the numbers in May, peaking in early June with almost three RCRC per session. The second peak of returning birds in mid-September is much smaller with only 1.5 birds/session on average. The counts of 2020 show an early arrival of birds (peak in second half of May), but overall, within the range of a typical year.


```{r seasonal-variation-counts, echo=TRUE, warning=FALSE, fig.cap = "Seasonal variation in the number of captured RCRC per session. Points represent actual data points while the black line is the model estimate for the default/average case (156m, 4hr) with its corresponding uncertainty illustrated as shaded area. Sessions with 6 or more RCRC are illustrated on the “6+” line but with proportionate size and colour. Black points correspond to the 2020 data, when the geolocators were equipped.", fig.asp=0.56, fig.align = 'center', fig.width=6}
p<-ggplot() +
  geom_point(data = dmrcrc %>% mutate(CountT= ifelse(Count>6,6,Count)), aes( x=DayOfYear, y=CountT, size=Count, color=Year), stroke=0, alpha=.6) +
  geom_point(data = dm2020s, aes( x=DayOfYear, y=Count, size=Count),stroke=0)+
  geom_ribbon(data = predictmod %>% filter(Year %in% 2020), aes(x=DayOfYear, ymin = lwrY, ymax = uprY ), color = NA, alpha=0.3) +
  geom_line(data = predictmod %>% filter(Year %in% 2020), aes(x=DayOfYear, y = fitY), size = 1) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill")) +
  xlab('Day of Year') + ylab('Number of Capture per Session') +
  scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                     labels=format(ISOdate(2004,1:12,1),"%b"),
                     minor_breaks = c(),
                     expand = c(0,0),
                     limits = c(100,365)) +
  scale_y_continuous(breaks=0:6,
                     minor_breaks = c(),
                     labels=c(0,1,2,3,4,5,'6+'),
                     expand = c(0,0),
                     limits = c(0,6)) +
  theme( aspect.ratio=9/16) + scale_size(limits = c(-2,11))

ggsave(filename = 'figures/figure1.pdf', plot = print(p), width = 16, height=9, units = "cm")
print(p)
```

We modelled the probability of recapture within a year to extract the number of unique birds captured during a single year (Figure \@ref(fig:prob-new-bird)). As the cumulative number of RCRC captured increases, so does the recapture rate and consequently, the probability of being a new bird decreases from around 100% for the first bird to 60-70% after 40 RCRCs have been captured in the year. Note that this approach can only reliably estimate the probability up to a maximum of around 40 RCRCs captured in a year. 


```{r prob-new-bird, echo=TRUE, fig.cap = "The probability of capturing a new bird (i.e., a bird not yet captured in the current year) as a function of the number of RCRC capture increases. The colour and size of the points indicate the number of occurrences in the dataset that the nth bird caught in a year had already been caught during the year (bottom, old bird, 0%) or the first time it was caught this year (top, new bird, 100%). The line shows the fitted model of the probability that a bird is a new bird as a function of its rank of capture.", fig.asp=0.56, fig.align = 'center', fig.width=6}
dmfFOY <- dmf %>% 
  filter(CommonName==specie_name) %>% 
  mutate(isFirstOfYear=as.integer(isFirstOfYear)) %>% 
  group_by(CountOfYear, isFirstOfYear) %>% 
  summarise( nb=n(), .groups="drop" )

p <- ggplot() +
  geom_point(data = dmfFOY, aes(x=CountOfYear, y=isFirstOfYear, color=nb, size=nb)) +
  geom_point(data = dm2020 %>% filter(!is.na(Age)), aes(x=CountOfYear, y=as.numeric(!isRetrap))) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill")) +
  geom_ribbon(data = predictmodFOY, aes(x=CountOfYear, ymin = lwr3, ymax = upr3 ), color = NA, alpha=0.4) +
  geom_line(data = predictmodFOY, aes(x=CountOfYear, y = fit), size = 1) +
  xlab('Cumulative number of birds caught along a year') + ylab('Probability of being a new bird')+
  scale_x_continuous( minor_breaks = c(), expand = c(0,0)) +
  scale_y_continuous( minor_breaks = c(), expand = c(0,0), labels = scales::percent) +
  theme(aspect.ratio=9/16, legend.position="top")

ggsave(filename = 'figures/figure2.pdf', plot = print(p), width = 16, height=9, units = "cm")
print(p)
```

```{r total-rcrc-captured, echo=TRUE, warning=FALSE, fig.cap = "Model predictions of the total unique RCRC caught along a year following different scenarios. The default scenario consists of 4hr ringing sessions using 156m of nets every 10 days. ‘6h’ and ‘225m’ are modifications of the default scenario, and ‘optimized’ increases the number of sessions (to every week) during the peak passage (mid-May – July) and decreases them (to every 2 weeks) during the rest of the year. Finally, using the exact date, duration, and net length used in 2020, the model prediction ‘2020 model’ can be compared to the actual data (‘2020 data’).", fig.asp=0.56, fig.align = 'center', fig.width=6}
bind_pred <- bind_rows(
  predictf(modY, yearf=2020, dayf=seq(1,365,10), netsLengthf=156, netsDurationf = 4) %>% mutate(scenario="default"),
  predictf(modY, yearf=2020, dayf=seq(1,365,10), netsLengthf=156, netsDurationf = 5) %>% mutate(scenario="6h"),
  predictf(modY, yearf=2020, dayf=seq(1,365,10), netsLengthf=200, netsDurationf = 4) %>% mutate(scenario="200m"),
  #predictf(mod, yearf=2020, dayf=seq(1,365,14), netsLengthf=156, netsDurationf = 4) %>% mutate(scenario="every 2 week"),
  predictf(modY, yearf=2020, dayf=c(seq(1,127,14), seq(130.5,183,7), seq(190,365,14)), netsLengthf=156, netsDurationf = 6) %>% mutate(scenario="optimized"),
  predictf(modY, yearf=2020, dayf=dm2020s$DayOfYear, netsLengthf=156, netsDurationf = dm2020s$Duration) %>% mutate(scenario="2020"),
) %>% 
  group_by(scenario) %>% 
  mutate( 
    fit.cumsum = cumsum(fit),
    #se.fit.cumsum = sqrt(cumsum(se.fit^2)),
    FoY = predict(modFoY,data.frame(CountOfYear=fit.cumsum),type = "response"),
    #se.FoY = predict(modFoY,data.frame(CountOfYear=fit.cumsum),type = "response", se.fit = T)%>% .$se.fit,
    fit.cumsum.FOY = cumsum(fit*FoY),
    #se.fit.cumsum.FOY = sqrt(cumsum( (FoY^2)*(se.fit^2) + fit^2*se.FoY^2 + se.fit^2*se.FoY^2 )),
    )

p <- bind_pred %>% 
  ggplot()+
  #geom_ribbon( aes(group = scenario, color = factor(scenario), x=DayOfYear, ymin = fit.cumsum-se.fit.cumsum, ymax = fit.cumsum+se.fit.cumsum), alpha=0.1, color = NA) +
  #geom_step(   aes(group = scenario, color = factor(scenario), x=DayOfYear, y=fit.cumsum), size=1)+
  #geom_ribbon( aes(group = scenario, color = factor(scenario), x=DayOfYear, ymin = fit.cumsum.FOY-3*se.fit.cumsum.FOY, ymax = fit.cumsum.FOY+3*se.fit.cumsum.FOY), alpha=0.1, color = NA) +
  geom_line( aes(group = scenario, color = factor(scenario), x=DayOfYear, y=fit.cumsum.FOY), size=1) +
  geom_point( aes(group = scenario, color = factor(scenario), x=DayOfYear, y=fit.cumsum.FOY), size=2) +
  geom_line( data = dm2020s, aes(x=DayOfYear, y=CountFOY.cum), size=1) +
  geom_point( data = dm2020s, aes(x=DayOfYear, y=CountFOY.cum), size=2) +
  labs(x='Day of Year', y="Cumulative number of unique RCRC captured") +
  scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                     labels=format(ISOdate(2004,1:12,1),"%b"),
                     expand = c(0,0),
                     limits = c(100,365)) +
  scale_y_continuous( minor_breaks = c(), expand = c(0,0), limits=c(0,25)) +
  theme(aspect.ratio=9/16, legend.position="top")

ggsave(filename = 'figures/figure3.pdf', plot = print(p), width = 16, height=9, units = "cm")
print(p)
```

Five different scenarios of ringing were modelled to estimate the total number of unique RCRC captured along the year in Figure \@ref(fig:total-rcrc-captured). Compared with the total number of birds caught at the end of year with the default scenario (`r bind_pred %>% filter(scenario=="default") %>% .$fit.cumsum.FOY %>% max() %>% round()`), increasing the duration of ringing sessions by two hours (‘6hr’) or adding 44m of additional nets (‘200m’) results in only three more birds caught (`r bind_pred %>% filter(scenario=="6h") %>% .$fit.cumsum.FOY %>% max() %>% round()`). However, the optimized scenario yields many more birds, with a total of `r bind_pred %>% filter(scenario=="optimized") %>% .$fit.cumsum.FOY %>% max() %>% round()` birds captured in fewer number of sessions (`r bind_pred %>% filter(scenario=="optimized") %>% nrow()` instead of `r bind_pred %>% filter(scenario=="default") %>% nrow()`).

In 2020, `r dm2020s %>% nrow()` ringing sessions were held with 156 m of mist nets, with an average duration of 3:45 (SD: 0:59). As of the 1st of November, a total of `r sum(dm2020s$Count)` RCRC were capture from `r sum(dm2020s$CountFOY)` unique individuals. For the exact same information, the model predicted an expected total of `r bind_pred %>% filter(scenario=="2020") %>% .$fit.cumsum %>% max() %>% round()` RCRC from `r bind_pred %>% filter(scenario=="2020") %>% .$fit.cumsum.FOY %>% max() %>% round()` individuals. 




## Recapture model

Over the `r nrow(dr %>% filter(retrap_i<1))` unique RCRC individuals captured in the dataset, `r nrow(dr %>% filter(retrap_i<1 & isRetrap))` (`r round(mean(dr %>% filter(retrap_i<1) %>% .$isRetrap)*100)`%) were recaptured at least once (including recapture the same year). When considering the `r dr %>% nrow()` capture events (including same individuals), the general recapture rate increases to `r round(mean(dr %>% .$isRetrap)*100)`%. However, looking at captures with recapture in any subsequent year, the recapture rate is `r round(mean(dr %>% .$nextSeason)*100)`%.  In the rest of the study, we employ the latter definition of recapture rate to eliminate intra-season recaptures and consider only recaptures in subsequent years, when geolocators can be retrieved. 

In general, adults show a slightly higher recapture rate (`r round(mean(dr %>% filter(isAdult) %>% .$nextSeason)*100)`%) than juveniles (`r round(mean(dr %>% filter(!isAdult) %>% .$nextSeason)*100)`%). When modelled over the day of year (Figure \@ref(fig:recapture-rate)a), the recapture rate in subsequent years shows that birds equipped later in the year are twice as likely to be recaptured, with a recapture rate increasing from 25% to almost 50%. Separating adults from juveniles allows us to identify further trends. The increase in juveniles’ recapture rate is not significant. By contrast, adults show a clear increase from May to August, before stabilising from September to October. Modelling the number of captures of adults and juveniles (Figure \@ref(fig:recapture-rate)b), we observe an earlier arrival of juveniles (late May vs early June for adults) and earlier departure in August, while adults show a second peak early October.

Finally, a RCRC which has already been captured in the past has a higher recapture rate (`r round(mean(dr %>% filter(retrap_i>0) %>%  .$nextSeason)*100)`%) compared to a bird without a ring (`r round(mean(dr %>% filter(retrap_i==0) %>%  .$nextSeason)*100)`).


```{r recapture-rate, echo=TRUE, warning=FALSE, fig.cap="Comparison of adult (green) and juvenile (yellow) trend in (a) recapture rate in subsequent year and (b) number of captures per session throughout the year.", fig.asp=1.125, fig.align = 'center', fig.width=6}
p1 <- ggplot() +
  geom_point( data=dr, aes(x=DayOfYear, y=as.numeric(nextSeason), color=isAdult ), size=2) +
  geom_line(data=predictmodr, aes(x=DayOfYear, y=rJ.fit), color = wes_palette('Cavalcanti1')[1], size=1) +
  geom_ribbon(data=predictmodr, aes(x=DayOfYear, ymin = rJ.fit-3*rJ.se.fit, ymax = rJ.fit+3*rJ.se.fit), alpha=0.3, fill = wes_palette('Cavalcanti1')[1]) +
  geom_line(data=predictmodr, aes(x=DayOfYear, y=rA.fit), color = wes_palette('Cavalcanti1')[2], size=1) +
  geom_ribbon(data=predictmodr, aes(x=DayOfYear, ymin = rA.fit-rA.se.fit, ymax = rA.fit+rA.se.fit), alpha=0.3, fill = wes_palette('Cavalcanti1')[2]) +
  geom_line(data=predictmodr, aes(x=DayOfYear, y=r.fit), color = wes_palette('Cavalcanti1')[4], size=2) +
  geom_ribbon(data=predictmodr, aes(x=DayOfYear, ymin = r.fit-r.se.fit, ymax = r.fit+r.se.fit), alpha=0.3, fill = wes_palette('Cavalcanti1')[4]) +
  scale_color_manual( values=wes_palette('Cavalcanti1')) +
  scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                   labels=format(ISOdate(2004,1:12,1),"%b"),
                   expand = c(0,0),minor_breaks = c(),
                   limits = c(100,350)) +
  scale_y_continuous(expand = c(0,0),minor_breaks = c(), labels = scales::percent) +
  theme(aspect.ratio=9/16, legend.position="none")  + labs(y='Probability of Recapture', color = "Adult", x='Day of Year')

p2 <- dmrcrc %>% 
  ggplot() +
    geom_point(aes( x=DayOfYear, ifelse(CountAd>2,2,CountAd), size=CountAd) , color=wes_palette('Cavalcanti1')[2]) +
    geom_point(aes( x=DayOfYear, y=ifelse(CountJuv>2,2,CountJuv), size=CountJuv), color=wes_palette('Cavalcanti1')[1]) +
    geom_line(data = predictmod %>% filter(Year %in% 2020), aes(x=DayOfYear, y = fitAd), color=wes_palette('Cavalcanti1')[2], size = 2) +
    geom_line(data = predictmod %>% filter(Year %in% 2020), aes(x=DayOfYear, y = fitJuv), color=wes_palette('Cavalcanti1')[1], size = 2) +
    geom_point(data = dm2020s, aes( x=DayOfYear, y=ifelse(CountJuv>2,2,CountJuv), size=CountJuv),stroke=0, colour=wes_palette('Cavalcanti1')[5])+
    geom_point(data = dm2020s, aes( x=DayOfYear, y=ifelse(CountAd>2,2,CountAd), size=CountAd),stroke=0, colour=wes_palette('Cavalcanti1')[4] )+
    labs(x='Day of Year', y="Count") +
    scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                       labels=format(ISOdate(2004,1:12,1),"%b"),
                       minor_breaks = c(),expand = c(0,0),
                      limits = c(100,365))+
    scale_y_continuous(limits = c(0,2), expand = c(0,0),minor_breaks = c())+
    theme(aspect.ratio=9/16, legend.position="none")
  
p <- arrangeGrob(p1, p2)

ggsave(filename = 'figures/figure4.pdf', plot = p, width = 16, height=9*2, units = "cm")
grid.arrange(p)

```




# Discussion

In this paper, we provide an example of how a ringing dataset can inform the design and planning of a geolocator study.


## How many captures?

The method outlined above allows us to estimate the total number of individual birds that can be captured and equipped with geolocators during a single season while accounting for the ringing schedule (number of sessions along the year, length of nets, and session duration). 

In addition, the capture model provides practical information for planning ringing sessions with the goal of maximizing the number of RCRC captured. Increasing the duration of ringing sessions from four to six hours and increasing the length of nets only slightly improves the total number of RCRC captured. This is explained by the fact that RCRC are mostly active in the early hours of the day, and that additional nets are placed in successively sub-optimal habitats. By contrast, increasing the number of sessions as well as selecting the right time of year significantly increases the number of captures. This model allows us to identify an optimal ringing schedule, with the highest number of RCRC captured (22 vs 16) for the fewest ringing sessions (31 vs 37) (Figure \@ref(fig:total-rcrc-captured)).

In 2020, the initial plan was to ring at minimum every two weeks, and every week during peak passage (from May to early June and from late August to October). Following an earlier and simpler capture model (not accounting for annual trends or recapture rates), we expected to capture a total of 30 individuals. Because of uncertainties surrounding the first deployment year, we conservatively requested 15 geolocators. This was meant to allow for flexibility in learning how to equip, and how to select which birds to equip and when throughout the year. 



## How to improve recapture rates?

For the geolocator study to be successful, not only do we need to maximize the number of birds equipped (with minimal ringing effort), but also optimize their recapture (i.e. number of geolocators retrieved). We analysed the recapture data for two parameters: age class, and capture date in the year.  

Equipping individuals which have already been captured before has the largest influence on recapture, improving the probability of recapture by 1.5 times (36% vs 24%). Moreover, equipping adults provides better probability of recapture than juvenile (34% vs 27%). This is especially true for adults captured later in the year, which suggest that these adults are holding territories on site and thus coming back every year.

This information was included in our deployment by equipping all adults, especially if they had already been captured. While waiting for July/August seemed preferable to increase the recapture rate, the number of birds captured decreases strongly in this period. In addition, to learn more about the age difference patterns observed in the ringing data and to test the hypothesis of variable departure/arrival dates based on age, we decided to equip both juveniles and adults. In practice, we limited ourselves to the deployment of 6 RCRC up to mid-June (out of the 15 available), when juveniles were more common (74%), in order to have enough geolocators in July and August, when we were able to equip more adults (53%).
Model validation, limitation and extension

We can loosely validate the capture model results with the actual data collected in 2020, though caution is needed as this represents only a single year. The number of RCRC captured in 2020 is comparable to the model estimate, albeit slightly higher. The arrival date proved to be earlier than the average and the numbers appeared to be higher than average at the beginning of the season. This could be due to a particularly good breeding season (many juveniles caught during this period) and/or affected by the playback used near the nets (not done in previous years).  
The approach followed in this paper contains some limitations. Firstly, we considered a recapture as when a bird was captured again in any subsequent year of the initial capture.  However, for a geolocator study, the recapture needs to happen within the duration of the study. The recapture rate of the full dataset (30%) reduces to 19% when considering only recaptures happening exactly the following year, 26% for the following 2 years, and 28% for the following 3 years. This suggests that we should keep ringing for at least 2 seasons after captures to benefit from a maximum of geolocator data. Secondly, by using recapture data from the ringing database as a proxy for recaptures involving geolocators, we ignore the effect of geolocators on survival rate (or site fidelity). There have been instances where geolocators have had an impact on survival, thus leading to lower recapture rates than for rings (unknown effect of ring).  

One last question remained to be answered to finalise the geolocator study, and that was when nets should be put up in the following year to attempt to recapture birds. To answer that question, we simply verified that the probability of capturing a recapture (i.e. a bird captured before) or a new bird is the same throughout the year. We verified that this is the case in Figure 9 in SM3, thus suggesting that one simply needs to follow the result of how to maximize captures to also maximize recaptures. 

Although the model and results of this study are tailored for the specific case of RCRC on coastal Kenya, the application of this methodology can be extended to other situations where ringing data are available for a study site. In general, our methodology is only applicable for cases where the deployment of geolocators is performed with the same technique (e.g. mist net, nest trap, spring nest trap) and context (e.g. place, time, general ringing effort) as the ringing database. In this study, we carried out analyses comparing only adults and juveniles, because it is not possible to determine the sex of a bird in hand. The same analysis can be performed on any class of bird identified by ringers (sex, molt stage, breeding status, subspecies). 


# Conclusion

The use of geolocators to study the migratory patterns of smaller birds has accelerated in recent years, offering an affordable solution to better understand, or uncover yet unknown migration routes and sites. This is of particular relevance for Afro-tropical migrants, many of which are still widely understudied and poorly understood, often due to lack of adequate research funding. Along with an increased collective experience in geolocator deployment, the design of studies and analysis of retrieved data has considerably improved. To further contribute to this effort, this study explores avenues for optimizing the deployment of geolocators, in terms of how many, when, and which birds to equip throughout a ringing season in order to maximize re-capture and subsequent retrieval of data. Using the case study of a geolocator study on Red-capped Robin-chats, we exploit the potential of an existing ringing database to inform these questions and design a study. This initial research opens the door for further applications of ringing data to inform geolocator studies. 




































# Supplementary Materials

## SM1. Data extends

The ringing sessions are relatively well-spread throughout the year (y-axis in Figure \@ref(fig:coverage)), although with a slightly higher intensity in March-April than June-July or December-January. The distribution is more heterogenous when comparing different years (x-axis in Figure \@ref(fig:coverage)): there is very good coverage between 2003 and 2007, variable from 2008 to 2012, and relatively correct since then. 

```{r coverage, echo=TRUE, fig.cap = "Distribution of the ringing sessions according to year and month. Colour scale indicates the number of ringing sessions.", fig.width = 12, fig.height=10, fig.align = 'center'} 
p1<-ggplot(dt, aes(x = Year, y = Month, color=nb)) +
  geom_point(size = 10, shape=15) +
  scale_colour_gradientn(colours = brewer.pal(9, 'YlGnBu')) +
  coord_fixed() +
  scale_y_continuous(breaks=1:12) +
  scale_x_continuous(breaks=min(dt$Year):max(dt$Year))
p3<-ggplot(dt, aes(x=Year)) + geom_histogram(bins=length(min(dt$Year):max(dt$Year))) + 
  scale_x_continuous(breaks=min(dt$Year):max(dt$Year))
p2<-ggplot(dt, aes(x=Month)) + geom_histogram(bins=12) + coord_flip() + 
  scale_x_continuous(breaks=1:12)

p <- arrangeGrob(p1,p2,p3,layout_matrix = cbind(c(2,2,2,6), c(1,1,1,3), c(1,1,1,3), c(1,1,1,3)))

ggsave(filename = 'figures/figureSM1.pdf', plot = p, width = 50, height=50, units = "cm")
grid.arrange(p)
```

Additional information for each session was available for some sessions: start time (data available for `r round(sum(!is.na(dmrcrc$NetsOpen))/nrow(dmrcrc)*100 )`% of the sessions), closing time (`r round(sum(!is.na(dmrcrc$NetsDuration))/nrow(dmrcrc)*100 )`%), sum of net lengths (`r round(sum(!is.na(dmrcrc$NetsLength))/nrow(dmrcrc)*100 )`%), weather conditions (`r round(sum(!is.na(dmrcrc$WeatherCat))/nrow(dmrcrc)*100 )`%).

```{r metadata, echo=TRUE, warning=FALSE, fig.cap = "Histograms of the metadata collected for each ringing session (N=317) of (a) total length of nets (N=73), (b) duration of ringing session (N=124), (c) weather category (N=143) and (d) time of session start (N=235).", fig.asp=0.56, fig.align = 'center', fig.width=6}
plot1 <- dmrcrc %>% ggplot() + geom_histogram(aes(x=NetsLength), binwidth = 25) + scale_x_continuous(breaks=seq(0,250,50), minor_breaks = c(), expand = c(0,0)) + scale_y_continuous(minor_breaks = c(), expand = c(0,0))
plot2 <- dmrcrc %>% ggplot() + geom_histogram(aes(x=NetsDuration), binwidth = 0.5) + scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + scale_y_continuous(minor_breaks = c(), expand = c(0,0))
plot3 <- dmrcrc %>% filter(!is.na(WeatherCat)) %>% ggplot() + geom_histogram(aes(x=WeatherCat),stat="count") + scale_y_continuous(minor_breaks = c(), expand = c(0,0))
plot4 <- dmrcrc %>% ggplot() + geom_histogram(aes(x=NetsOpen), binwidth = 0.25) + scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + scale_y_continuous(minor_breaks = c(), expand = c(0,0))
p <- arrangeGrob(plot1, plot2,  plot3, plot4, ncol=2)

ggsave(filename = 'figures/figureSM2.pdf', plot = p, width = 16, height=9, units = "cm")
grid.arrange(p)
```

```{r, fig.cap='Sessions dataset'}
DT::datatable(dmrcrc %>% arrange(Date))
```

```{r, fig.cap='Rings dataset'}
DT::datatable(dr %>% arrange(Date))
```

```{r, fig.cap='2020 dataset'}
DT::datatable(dm2020s %>% arrange(Date))
```


## SM2. Capture model

The GAM of the count (i.e. number of RCRC captured per session) was tested with (1) year (2) day-of-year, (3) duration of the sessions and (4) starting time, (5) total length of nets and (6) weather. We first tested a GAM smoothing for each variable separately to analyse its effect (Figure \@ref(fit-meta)).

 1. *Year* (Figure\@ref(fit-meta)a). A general decline in the overall number of birds is observed over the 20 years of the dataset. It was included as a smoothing term. 
 2. *Day-of-year* (Figure 8b). Day-of-year has a strong influence on the number of captures and varies non-linearly. This variable is thus included in the model as a smoothing term.
 3. *Duration* (Figure \@ref(fit-meta)c). The duration of the session computed as the difference between closing time and opening time shows a positive correlation with the number of captures. It is thus included in the model as a linear term. 
 4. *Net opening time* (Figure \@ref(fit-meta)d). The fit of the opening time seems to indicate a higher capture rate for sessions starting later. This relationship is contrary to common knowledge and considered non-meaningful. It is thus not retained for the model.
 5. *Sum of net lengths* (Figure \@ref(fit-meta)e). Between 50 and 200m, the fit shows an increase of captures as the total length of the nets increases. Yet, above 200m, the fit shows a stabilisation of the count. This is explained by the fact that the nets added above 200m are located in habitats which are not ideal for RCRC and thus do not contribute to an increase in capture. This term is included as a smoothing term. 
 6. *Weather categories* (Figure \@ref(fit-meta)f). The weather categories do not show a clear pattern and are thus not included in the model. 


```{r fit-meta, echo=TRUE, warning=FALSE, fig.cap = "Number of RCRC captured by session as a function of (a) total length of nets, (b) duration of ringing session, (c) weather category and (d) time of session start. The red line with shaded area is a smoothed curved fitted on the data (GAM or GLM)", fig.asp=0.84, fig.align = 'center', fig.width=12}

plot1 <- #ggplot(data=predictmod %>% filter(date<'2019-01-01' & date>'2002-01-01'),aes(x=date)) +
  ggplot(data=dmrcrc %>% filter(Date>'2002-01-01'), aes(x=Year,y=Count)) +
  geom_smooth(method="gam", formula = y ~ s(x), method.args = list(family = "poisson")) + 
  #geom_point(data= dmrcrc, aes(Year, Count)) +
  geom_point(data=(dmrcrc %>% filter(Date>'2002-01-01')%>% mutate( Countt=ifelse(Count>6,6,Count)) %>% group_by(Year,Countt) %>% tally() %>% filter(!is.na(Year))), aes(x=Year, y=Countt, size=n, color=n)) +
  scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0)) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill"), limits = c(0,25)) +
  geom_point(data= dm2020s %>% mutate(Count=ifelse(Count>6,6,Count)) %>% group_by(Count) %>% tally(), aes( x=2020, y=Count, size=n) ) +
  ylab('Number of RCRC capture per session') + xlab('(a) Year') + theme(aspect.ratio=9/16)

plot2 <- dmrcrc %>% ggplot(aes(y=Count,x=DayOfYear)) + 
  geom_smooth(method="gam", formula = y ~ s(x), method.args = list(family = "poisson")) + 
  geom_point(data=(dmrcrc %>% mutate(nlg = round(DayOfYear/31)*31, Countt=ifelse(Count>6,6,Count)) %>% group_by(nlg,Countt) %>% tally() %>% filter(!is.na(nlg))), aes(x=nlg,y=Countt,size=n, color=n)) +
  scale_x_continuous(minor_breaks = c(), expand = c(0,0),
                     breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                     labels=format(ISOdate(2004,1:12,1),"%b")) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0)) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill"), limits = c(0,25)) +
  theme(aspect.ratio = 9/16) + xlab('(b) DayOfYear')


plot3 <- dmrcrc %>% ggplot(aes(y=Count,x=NetsDuration)) + 
  geom_point(data=(dmrcrc %>% mutate(nlg = round(NetsDuration/0.5)*0.5, Countt=ifelse(Count>6,6,Count)) %>% group_by(nlg,Countt) %>% tally() %>% filter(!is.na(nlg))), aes(x=nlg,y=Countt,size=n, color=n)) + 
  geom_smooth(method="glm", formula = y ~ x, method.args = list(family = "poisson")) + 
  scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0)) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill"), limits = c(0,25)) +
  theme(aspect.ratio = 9/16) + xlab('(c) Duration')

plot4 <- dmrcrc %>% ggplot(aes(y=Count,x=NetsOpen)) + 
  geom_smooth(formula = y ~ x, method="glm", method.args = list(family = "poisson")) + 
  geom_point(data=(dmrcrc %>% mutate(nlg = round(NetsOpen/0.125)*0.125, Countt=ifelse(Count>6,6,Count)) %>% group_by(nlg,Countt) %>% tally() %>% filter(!is.na(nlg))), aes(x=nlg,y=Countt,size=n, color=n)) + 
  scale_x_continuous(minor_breaks = seq(5.5,7,0.125), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0)) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill"), limits = c(0,25)) +
  theme(aspect.ratio = 9/16) + xlab('(d) Net opening time')

plot5 <- dmrcrc %>% ggplot(aes(y=Count,x=NetsLength)) + 
  geom_smooth(method="gam", formula = y ~ s(x,k=2), method.args = list(family = "poisson")) + 
  geom_point(data=(dmrcrc %>% mutate(nlg = round(NetsLength/25)*25, Countt=ifelse(Count>6,6,Count)) %>% group_by(nlg,Countt) %>% tally() %>% filter(!is.na(nlg))), aes(x=nlg,y=Countt,size=n, color=n)) +
  scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0)) +
  scale_color_gradientn(colours = wes_palette(pal.name, type = "continuous"), aesthetics = c("colour", "fill"), limits = c(0,25)) +
  theme(aspect.ratio = 9/16) + xlab('(e) Sum of net lengths')

plot6 <- dmrcrc %>% filter(!is.na(WeatherCat)) %>% ggplot(aes(x=Count, fill=WeatherCat)) + 
  geom_histogram(binwidth = 1) + 
  scale_x_continuous(minor_breaks = c(), expand = c(0,0), limits=c(-1,7)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0), limits=c(0,25)) +
  theme(aspect.ratio = 9/16) + coord_flip() + xlab('(f) Weather categories')

p <- arrangeGrob(plot1, plot2, plot3, plot4, plot5, plot6, ncol=2, nrow = 3)

ggsave(filename = 'figures/figureSM3.pdf', plot = p, width = 16*2, height=9*3, units = "cm")

grid.arrange(p)
```

The retained model was `Count ~ s(Year) + s(DayOfYear) + NetsDuration + NetsLength`.

```{r, echo=TRUE, fig.asp=0.84, fig.align = 'center', fig.width=6, fig.cap="Summury of the count model fit (GAM)"}
# choose model number 4 randomly amongst the 30 generated due to the missing data.
summary(modY[[4]])
```

```{r, echo=TRUE, fig.asp=0.84, fig.align = 'center', fig.width=6, fig.cap="Visual summury of the count model fit (GAM)" }
par(mfrow=c(2,2))
visreg(modY[[4]])
```

## SM3.	Recapture model

```{r weight-recapture, echo=TRUE, fig.cap="Histograms of the weight of RCRC recaptured in a following year and those not recaptured, together with the model fit. The uncertainty of the model shows that weight has an unclear influence on the recatpure rate.", fig.asp=1.125, fig.align = 'center', fig.width=6}
p1 <- dr %>% filter(Weight<50) %>%
  ggplot(aes(x=Weight, colour=nextSeason)) +
  geom_histogram(binwidth=1) + 
  scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0), limits = c(0,50)) +
  theme(aspect.ratio = 9/16, legend.position = "none")
  

p2 <- dr %>% filter(Weight<50) %>% 
  ggplot(aes(y=as.numeric(nextSeason), x=Weight)) +
  geom_smooth(method="glm", formula = y ~ x, method.args = list(family = "binomial")) + 
  scale_x_continuous(minor_breaks = c(), expand = c(0,0)) + 
  scale_y_continuous(minor_breaks = c(), expand = c(0,0), limits = c(0,1), labels = scales::percent) +
  theme(aspect.ratio = 9/16)

p <- arrangeGrob(p1, p2)

ggsave(filename = 'figures/figureSM4.pdf', plot = p, width = 16, height=9*2, units = "cm")
grid.arrange(p)
```


```{r expection, echo=TRUE, warning=FALSE, fig.asp=0.56, fig.align = 'center', fig.width=6}
p <- predictmod %>% 
  filter(Year %in% 2020) %>% 
  left_join(predictmodr, by="DayOfYear") %>% 
  mutate( 
    exAd = fitAd * rA.fit,
    exJuv = fitJuv * rJ.fit,
    ex = fit * r.fit
    ) %>% 
  ggplot() +
  geom_line(aes(x=DayOfYear, y = exJuv), color = wes_palette('Cavalcanti1')[1], size=1) +
  geom_line(aes(x=DayOfYear, y = exAd), color = wes_palette('Cavalcanti1')[2], size=1) +
  geom_line(aes(x=DayOfYear, y = ex),color = wes_palette('Cavalcanti1')[4], size=2) +
  scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                   labels=format(ISOdate(2004,1:12,1),"%b"),
                   limits = c(100,350)) +
  theme(aspect.ratio=9/16, legend.position="top")  + labs(y='Expection of Recapture', x='Day of Year')

ggsave(filename = 'figures/figureSM5.pdf', plot = p, width = 16, height=9, units = "cm")
print(p)
```

```{r capture vs recapture, echo=TRUE, warning=FALSE, fig.cap="Variation throughout the year of the probability that a bird captured is a bird that has been captured in previous years. Blue dots denote the data for each capture of the database and the red line denote the GLM fit of a binomial model. The probability doesn’t change throughout the year indicating that maximizing the capture of bird captured previous season is the same as maximizing the number of capture.", fig.asp=0.56, fig.align = 'center', fig.width=6}
p <- dr %>% ggplot(aes(x=DayOfYear, y=as.numeric(isARetrap))) +
  geom_point(  size=2) +
  geom_smooth(method="glm",  formula = y ~ x, method.args = list(family = "binomial")) +
  scale_color_manual( values=wes_palette('Cavalcanti1')) +
  scale_x_continuous(breaks=as.numeric(format(ISOdate(2004,1:12,1),"%j")),
                   labels=format(ISOdate(2004,1:12,1),"%b"),
                   expand = c(0,0),minor_breaks = c(),
                   limits = c(100,350)) +
  scale_y_continuous(expand = c(0,0),minor_breaks = c(), labels = scales::percent) +
  theme(aspect.ratio=9/16, legend.position="none")  + labs(y='Probability of Capturing a recapture', color = "Adult", x='Day of Year')

ggsave(filename = 'figures/figureSM6.pdf', plot = p, width = 16, height=9, units = "cm")
print(p)
```


```{r, echo=TRUE, warning=FALSE, fig.asp=0.56, fig.align = 'center', fig.width=6}
nextSeasonI <- c()
for (i in (1:10)){
  nextSeasonI[i] <- mean(pmap_lgl( dr %>% select(Year, RingNo), ~ any(.x < dr$Year & .x >= dr$Year-i  & .y == dr$RingNo)))
}


p <- data.frame(x=(1:10),y=nextSeasonI) %>% ggplot( aes(y = y, x=x)) +
  geom_point( size=2) +
  geom_line() +
  scale_y_continuous(expand = c(0,0), minor_breaks = c(), labels = scales::percent, lim=c(0,.5)) +
  scale_x_continuous(expand = c(0,0), breaks = c(1:10), minor_breaks = c()) +
  theme(aspect.ratio=9/16, legend.position="none")  + labs(y='Probability of recapture', color = "Adult", x='Day of Year')

ggsave(filename = 'figures/figureSM7.pdf', plot = p, width = 16, height=9, units = "cm")
print(p)
```

```{r, echo=TRUE, fig.asp=0.84, fig.align = 'center', fig.width=6, fig.cap="Summury of the recapture model fit (GLM)"}
summary(modFoY)
```

```{r, echo=TRUE, fig.asp=0.84, fig.align = 'center', fig.width=6, fig.cap="Visual summury of the recapture model fit (GLM)" }
visreg(modFoY)
```




# Acknowledgements {.appendix}

This work was supported by a grant from the Swiss Ornithological Institute. We thank A Rocha Kenya for providing their ringing dataset, and for carrying out field work to equip Red-capped Robin-chats with geolocators. We thank Martins Briedis, Matthew Sjaarda, Burri Reto and Améline Nussbaumer for their valuable contributions to the paper.

# Data Accessibility {.appendix}

Ringing dataset and the code used to generate the results of this manuscript are available at [github.com/A-Rocha-Kenya/How-many-when-and-which-birds-to-equip](https://github.com/A-Rocha-Kenya/How-many-when-and-which-birds-to-equip).
